name: Veil — Security Baseline Gate (strict)

on:
  push: { branches: ["**"] }
  pull_request:

permissions:
  contents: read
  security-events: read
  pull-requests: write   # for sticky PR comment

jobs:
  sbg:
    runs-on: ubuntu-latest
    steps:
      - uses: step-security/harden-runner@v2
        with: { egress-policy: audit }

      - uses: actions/checkout@v4

      - name: Run baseline checks
        id: gate
        shell: bash
        run: |
          set -eo pipefail
          fail=0; warn=0

          # SECURITY.md
          [[ -f SECURITY.md ]] || { echo "::error title=Missing SECURITY.md::Add a SECURITY.md"; fail=$((fail+1)); }

          # Dependabot
          [[ -f .github/dependabot.yml ]] || { echo "::error title=Missing dependabot.yml::.github/dependabot.yml not found"; fail=$((fail+1)); }

          # Dependency Graph “hint” (lockfiles)
          if ! ls **/package-lock.json **/pnpm-lock.yaml **/yarn.lock 2>/dev/null | head -n1 >/dev/null; then
            echo "::warning title=Dependency Graph may be empty::Commit a lockfile or enable automatic dependency submission."
            warn=$((warn+1))
          fi

          # SBOM presence
          if ! ls **/sbom.* **/*bom*.xml **/*.spdx* 2>/dev/null | head -n1 >/dev/null; then
            echo "::warning title=SBOM not found::Provide CycloneDX or SPDX, or submit via Dependency Submission API."
            warn=$((warn+1))
          fi

          echo "fail=$fail"  >> $GITHUB_OUTPUT
          echo "warn=$warn"  >> $GITHUB_OUTPUT

      - name: Write summary
        run: |
          {
            echo "## Veil SBG results"
            echo "- Failures: ${{ steps.gate.outputs.fail }}"
            echo "- Warnings: ${{ steps.gate.outputs.warn }}"
          } > veil.md

      - name: Sticky PR comment
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          path: veil.md

      - name: Fail if any failures
        if: steps.gate.outputs.fail != '0'
        run: exit 1
